generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum LeadStatus {
  NEW
  CONTACTED
  INTERESTED
  NOT_INTERESTED
  CLOSED
  SENT
  QUEUED
  FAILED
  SKIPPED
  INVALID
  FLAGGED
  BOUNCED
  REPLIED
  OPENED
  CLICKED
}

model Lead {
  id           String         @id @default(uuid())
  name         String
  email        String
  company      String
  website      String?
  status       LeadStatus     @default(NEW)
  notes        String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  campaignLeads CampaignLead[]

  @@index([email])  // Fast lookup for duplicate detection and unsubscribe
  @@index([status]) // Filter by status (active leads, unsubscribed, etc.)
}

model Template {
  id        String   @id @default(uuid())
  name      String
  subject   String
  body      String
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  steps     SequenceStep[]
  campaignsA Campaign[] @relation("CampaignTemplateA")
  campaignsB Campaign[] @relation("CampaignTemplateB")
}

model SmtpConfig {
  id            String   @id @default(uuid())
  provider      String   // "gmail", "outlook", "custom"
  host          String?
  port          Int?
  secure        Boolean  @default(true)
  user          String
  password      String   // Encrypted via AES-256-GCM
  fromName      String
  fromEmail     String
  dailyLimit    Int      @default(50)
  sentToday     Int      @default(0)
  lastResetDate DateTime @default(now())
  lastCronRun   DateTime?
  isSystemPaused Boolean  @default(false)
  createdAt     DateTime @default(now())

  @@index([lastResetDate])
}

model Campaign {
  id              String         @id @default(uuid())
  name            String
  templateId      String?        // Optional now, used for single-email campaigns
  templateBId     String?        // For A/B Testing
  template        Template?      @relation("CampaignTemplateA", fields: [templateId], references: [id])
  templateB       Template?      @relation("CampaignTemplateB", fields: [templateBId], references: [id])
  sequenceId      String?
  sequence        Sequence?      @relation(fields: [sequenceId], references: [id])
  status          String         @default("DRAFT") // DRAFT, ACTIVE, PAUSED, COMPLETED
  leads           CampaignLead[]
  scheduleConfig  String?        // JSON: { delayMin: 120, delayMax: 600, dailyLimit: 50 }
  searchQuery     String?        // e.g. "electrician in Dayton, OH"
  lastProcessedAt DateTime?
  isProcessing    Boolean        @default(false)
  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime       @default(now())

  @@index([status])
}

model CampaignLead {
  id           String    @id @default(uuid())
  campaignId   String
  campaign     Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  leadId       String
  lead         Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)
  status       String    @default("QUEUED") // QUEUED, SENDING, SENT, FAILED, BOUNCED
  scheduledFor DateTime?
  sentAt       DateTime?
  errorMessage String?
  retryCount   Int       @default(0)

  @@unique([campaignId, leadId])
  @@index([campaignId, status])  // Query leads for a campaign by status
  @@index([status])              // Global status filtering
  @@index([scheduledFor])        // Cron job queries for scheduled emails
  @@index([sentAt])              // Analytics and reporting queries
  
  // Sequence Tracking
  currentStep Int      @default(1)
  nextStepAt  DateTime?
}

model Sequence {
  id          String         @id @default(uuid())
  name        String
  description String?
  steps       SequenceStep[]
  campaigns   Campaign[]
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
}

model SequenceStep {
  id          String   @id @default(uuid())
  sequenceId  String
  sequence    Sequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)
  templateId   String?
  template     Template? @relation(fields: [templateId], references: [id])
  order       Int      // 1, 2, 3
  delayDays   Int      // Days to wait after previous step (0 for first step)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
